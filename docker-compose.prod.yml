# ============================================================
# PetPro Production Override
# 사용법: docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d
#
# 보안 참고: docker-compose.yml의 내부 서비스 포트는 모두 127.0.0.1에 바인딩됨
# 외부에서는 Nginx(80/443)만 접근 가능. 방화벽 설정은 scripts/secure-firewall.sh 참조
# ============================================================

services:
  nginx:
    extra_hosts:
      - "host.docker.internal:host-gateway"
    volumes:
      - ./docker/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./docker/nginx/conf.d-prod:/etc/nginx/conf.d:ro
      - /etc/letsencrypt:/etc/letsencrypt:ro
      - /var/www/certbot:/var/www/certbot:ro
      - ./frontend/build:/usr/share/nginx/html:ro
    ports:
      - "80:80"
      - "443:443"
    security_opt:
      - no-new-privileges:true

  # 컨테이너 보안 하드닝 (프로덕션)
  postgres-master:
    security_opt:
      - no-new-privileges:true
    deploy:
      resources:
        limits:
          memory: 512M

  postgres-slave1:
    security_opt:
      - no-new-privileges:true
    deploy:
      resources:
        limits:
          memory: 512M

  postgres-slave2:
    security_opt:
      - no-new-privileges:true
    deploy:
      resources:
        limits:
          memory: 512M

  postgres-coupon:
    security_opt:
      - no-new-privileges:true
    deploy:
      resources:
        limits:
          memory: 256M

  mysql-log-master:
    security_opt:
      - no-new-privileges:true
    deploy:
      resources:
        limits:
          memory: 512M

  mysql-log-slave:
    security_opt:
      - no-new-privileges:true
    deploy:
      resources:
        limits:
          memory: 512M

  redis:
    security_opt:
      - no-new-privileges:true
    deploy:
      resources:
        limits:
          memory: 256M

  minio:
    security_opt:
      - no-new-privileges:true
    deploy:
      resources:
        limits:
          memory: 512M

  prometheus:
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    deploy:
      resources:
        limits:
          memory: 256M

  loki:
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    deploy:
      resources:
        limits:
          memory: 256M

  promtail:
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    deploy:
      resources:
        limits:
          memory: 128M

  tempo:
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    deploy:
      resources:
        limits:
          memory: 256M

  grafana:
    security_opt:
      - no-new-privileges:true
    deploy:
      resources:
        limits:
          memory: 256M
